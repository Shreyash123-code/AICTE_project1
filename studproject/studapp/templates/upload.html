{% extends 'base.html' %}

{% block title %}Upload Notes â€” Stud Safe{% endblock %}

{% block content %}
<section class="upload-section" id="upload-section">
    <div class="upload-container">
        <div class="upload-header">
            <h1 class="page-title">Upload <span class="gradient-text">Notes</span></h1>
            <p class="page-subtitle">Share your study materials with the community. Help others while building your
                contributor profile!</p>
        </div>
        <form method="post" enctype="multipart/form-data" class="upload-form" id="upload-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="note-title">Title</label>
                {{ form.title }}
                {% if form.title.errors %}
                <span class="form-error">{{ form.title.errors.0 }}</span>
                {% endif %}
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="note-branch">ðŸŽ“ Branch</label>
                    {{ form.branch }}
                    {% if form.branch.errors %}
                    <span class="form-error">{{ form.branch.errors.0 }}</span>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="note-subject">ðŸ“˜ Subject</label>
                    {{ form.subject }}
                    {% if form.subject.errors %}
                    <span class="form-error">{{ form.subject.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="form-group">
                <label for="note-description">Description</label>
                {{ form.description }}
                {% if form.description.errors %}
                <span class="form-error">{{ form.description.errors.0 }}</span>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="note-file">File</label>
                <div class="file-upload-area" id="file-upload-area">
                    <div class="file-upload-content">
                        <span class="file-upload-icon">ðŸ“„</span>
                        <p class="file-upload-text">Drag & drop your file here, or <span class="file-upload-link">click
                                to browse</span></p>
                        <p class="file-upload-hint">Supports PDF, DOC, DOCX, PPT, PPTX, TXT, JPG, PNG</p>
                    </div>
                    <button type="button" class="file-remove-btn" id="file-remove-btn" title="Remove file">âœ•</button>
                    {{ form.file }}
                </div>
                {% if form.file.errors %}
                <span class="form-error">{{ form.file.errors.0 }}</span>
                {% endif %}
            </div>
            <button type="submit" class="btn btn-primary btn-lg btn-full" id="upload-submit">ðŸ“¤ Upload Notes</button>
        </form>
    </div>
</section>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .file-upload-area {
        position: relative;
    }

    .file-remove-btn {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        z-index: 5;
        transition: all 0.2s ease;
        display: none;
    }

    .file-remove-btn:hover {
        background: rgba(239, 68, 68, 0.3);
        transform: scale(1.1);
    }

    .file-upload-area.has-file .file-remove-btn {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (max-width: 600px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const branchSelect = document.getElementById('note-branch');
    const subjectSelect = document.getElementById('note-subject');

    // Clear subjects on page load â€” user must pick a branch first
    subjectSelect.innerHTML = '<option value="">-- Select Branch First --</option>';

    branchSelect.addEventListener('change', function () {
        const branchId = this.value;
        // Clear current options
        subjectSelect.innerHTML = '<option value="">-- Loading... --</option>';

        if (branchId) {
            fetch('/api/subjects/' + branchId + '/')
                .then(response => response.json())
                .then(data => {
                    subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
                    data.forEach(function (subj) {
                        const option = document.createElement('option');
                        option.value = subj.id;
                        option.textContent = subj.name;
                        subjectSelect.appendChild(option);
                    });
                })
                .catch(() => {
                    subjectSelect.innerHTML = '<option value="">-- Error loading subjects --</option>';
                });
        } else {
            subjectSelect.innerHTML = '<option value="">-- Select Branch First --</option>';
        }
    });

    // File upload area interactivity
    const fileInput = document.getElementById('note-file');
    const uploadArea = document.getElementById('file-upload-area');
    const uploadText = uploadArea.querySelector('.file-upload-text');

    uploadArea.addEventListener('click', (e) => {
        if (e.target !== fileInput) fileInput.click();
    });
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        updateFileName();
    });
    fileInput.addEventListener('change', updateFileName);

    const removeBtn = document.getElementById('file-remove-btn');

    function updateFileName() {
        if (fileInput.files.length > 0) {
            uploadText.textContent = fileInput.files[0].name;
            uploadArea.classList.add('has-file');
        }
    }

    removeBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        fileInput.value = '';
        uploadText.innerHTML = 'Drag & drop your file here, or <span class="file-upload-link">click to browse</span>';
        uploadArea.classList.remove('has-file');
    });

    // --- Client-side validation ---
    function showErr(input, msg) {
        const old = input.closest('.form-group').querySelector('.form-error');
        if (old) old.remove();
        const span = document.createElement('span');
        span.className = 'form-error';
        span.textContent = msg;
        input.closest('.form-group').appendChild(span);
    }

    document.getElementById('upload-form').addEventListener('submit', function (e) {
        this.querySelectorAll('.form-error').forEach(el => el.remove());
        let valid = true;

        const title = document.getElementById('note-title');
        if (title.value.trim().length < 3) {
            showErr(title, 'Title must be at least 3 characters.'); valid = false;
        }

        if (!branchSelect.value) {
            showErr(branchSelect, 'Please select a branch.'); valid = false;
        }
        if (!subjectSelect.value) {
            showErr(subjectSelect, 'Please select a subject.'); valid = false;
        }

        if (!fileInput.files.length) {
            showErr(fileInput, 'Please attach a file.'); valid = false;
        } else if (fileInput.files[0].size > 10 * 1024 * 1024) {
            showErr(fileInput, 'File is too large. Max size is 10 MB.'); valid = false;
        }

        if (!valid) e.preventDefault();
    });
</script>
{% endblock %}